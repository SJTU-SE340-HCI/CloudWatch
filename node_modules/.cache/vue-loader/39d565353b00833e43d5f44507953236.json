{"remainingRequest":"/run/media/gz/G/c2020spring/hci/project/FrontEnd/node_modules/vue-loader/lib/index.js??vue-loader-options!/run/media/gz/G/c2020spring/hci/project/FrontEnd/src/components/message/call-layer.vue?vue&type=script&lang=js&","dependencies":[{"path":"/run/media/gz/G/c2020spring/hci/project/FrontEnd/src/components/message/call-layer.vue","mtime":1588990158995},{"path":"/run/media/gz/G/c2020spring/hci/project/FrontEnd/node_modules/babel-loader/lib/index.js","mtime":1588990144242},{"path":"/run/media/gz/G/c2020spring/hci/project/FrontEnd/node_modules/cache-loader/dist/cjs.js","mtime":1588990144497},{"path":"/run/media/gz/G/c2020spring/hci/project/FrontEnd/node_modules/vue-loader/lib/index.js","mtime":1588990158440}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport RtcClient from '../../utils/rtc-client'\nimport { ACTION, VERSION } from '../../utils/trtcCustomMessageMap'\nimport { mapGetters, mapState } from 'vuex'\nimport { formatDuration } from '../../utils/formatDuration'\n\nexport default {\n  name: 'CallLayer',\n  data() {\n    return {\n      Trtc: undefined,\n      isCamOn: true,\n      isMicOn: true,\n      maskShow: false,\n      isLocalMain: true, // 本地视频是否是主屏幕显示\n      start: 0,\n      end: 0,\n      duration: 0,\n      hangUpTimer: 0, // 通话计时id\n      ready: false,\n      dialling: false, // 是否拨打电话中\n      calling: false, // 是否通话中\n      isDialled: false, // 是否被呼叫\n    }\n  },\n  computed: {\n    ...mapGetters(['toAccount', 'currentConversationType']),\n    ...mapState({\n      userID: state => state.user.userID,\n      userSig: state => state.user.userSig,\n      videoRoom: state => state.video.videoRoom,\n      sdkAppID: state => state.user.sdkAppID\n    }),\n    formatDurationStr() {\n      return formatDuration(this.duration)\n    },\n  },\n  created() {\n    window.addEventListener('beforeunload', () => {\n      this.videoCallLogOut()\n    })\n    window.addEventListener('leave', () => {\n      this.videoCallLogOut()\n    })\n  },\n  mounted() {\n    this.$bus.$on('isCalled', this.isCalled)\n    this.$bus.$on('missCall', this.missCall)\n    this.$bus.$on('isRefused', this.isRefused)\n    this.$bus.$on('isAccept', this.isAccept)\n    this.$bus.$on('isHungUp', this.isHungUp)\n    this.$bus.$on('busy', this.busy)\n    this.$bus.$on('video-call', this.videoCall)\n  },\n  beforeDestroy() {\n    this.$bus.$off('isCalled', this.isCalled)\n    this.$bus.$off('missCall', this.missCall)\n    this.$bus.$off('isRefused', this.isRefused)\n    this.$bus.$off('isAccept', this.isAccept)\n    this.$bus.$off('isHungUp', this.isHungUp)\n    this.$bus.$off('busy', this.busy)\n    this.$bus.$off('video-call', this.videoCall)\n  },\n  methods: {\n    videoCallLogOut() { // 针对，刷新页面，关闭Tab，登出情况下，通话断开的逻辑\n      if (this.dialling || this.calling) {\n        this.leave()\n      }\n      if (this.isDialled) {\n        this.refuse()\n      }\n    },\n    changeState(state, boolean) {\n      let stateList = ['dialling', 'isDialled', 'calling']\n      stateList.forEach(item => {\n        this[item] = item === state ? boolean : false\n      })\n      this.$store.commit('UPDATE_ISBUSY', stateList.some(item => this[item])) // 若stateList 中存在 true , isBusy 为 true\n    },\n    async initTrtc(options) { // 初始化 trtc 进入房间\n      this.Trtc = new RtcClient(options)\n      await this.Trtc.createLocalStream({ audio: true, video: true }).then(() => { // 在进房之前，判断设备\n          this.Trtc.join()\n          this.ready = true\n          this.isCamOn = true\n          this.maskShow = false\n      }).catch(() => {\n        alert(\n          '请确认已连接摄像头和麦克风并授予其访问权限！'\n        )\n        this.ready = false\n      })\n    },\n    videoCall() { // 发起通话\n      if (this.calling) { // 避免通话按钮多次快速的点击\n        return\n      }\n      this.isLocalMain = true\n      this.$store.commit('GENERATE_VIDEO_ROOM') // 初始化房间号\n      const options = {\n        userId: this.userID,\n        userSig: this.userSig,\n        roomId: this.videoRoom,\n        sdkAppId: this.sdkAppID\n      }\n      this.initTrtc(options).then(() => {\n        if (!this.ready) return\n        this.changeState('dialling', true)\n        this.timer = setTimeout(this.timeout, process.env.NODE_ENV === 'development' ? 999999 : 60000) // 开始计时器，开发环境超时时间较长，便于调试\n        this.sendVideoMessage(ACTION.VIDEO_CALL_ACTION_DIALING)\n      })\n    },\n    leave() { // 离开房间，发起方挂断\n      if (!this.calling) { // 还没有通话，单方面挂断\n        this.Trtc.leave()\n        clearTimeout(this.timer)\n        this.changeState('dialling', false)\n        this.sendVideoMessage(ACTION.VIDEO_CALL_ACTION_SPONSOR_CANCEL)\n        return\n      }\n      this.hangUp() // 通话一段时间之后，某一方面结束通话\n    },\n    timeout() { // 通话超时\n      this.changeState('dialling', false)\n      this.Trtc.leave()\n      this.sendVideoMessage(ACTION.VIDEO_CALL_ACTION_SPONSOR_TIMEOUT)\n    },\n    isCalled() { // 被呼叫\n      this.changeState('isDialled', true)\n    },\n    missCall() { // 错过电话，也就是发起方的电话超时挂断或自己挂断\n      this.changeState('isDialled', false)\n    },\n    refuse() { // 拒绝电话\n      this.changeState('isDialled', false)\n      this.sendVideoMessage(ACTION.VIDEO_CALL_ACTION_REJECT)\n    },\n    isRefused() { // 对方拒绝通话\n      this.changeState('dialling', false)\n      clearTimeout(this.timer)\n    },\n    resetDuration(duration) {\n      this.duration = duration\n      this.hangUpTimer = setTimeout(() => {\n        let now = new Date()\n        this.resetDuration(parseInt((now - this.start) / 1000))\n      }, 1000)\n    },\n    accept() { // 接听电话\n      this.changeState('calling', true)\n      const options = {\n       userId: this.userID,\n        userSig: this.userSig,\n        roomId: this.videoRoom,\n        sdkAppId: this.sdkAppID\n      }\n      this.initTrtc(options).then(() => {\n        if (!this.ready) {\n          this.changeState('calling', false)\n          this.sendVideoMessage(ACTION.VIDEO_CALL_ACTION_ERROR)\n          return\n        }\n        this.sendVideoMessage(ACTION.VIDEO_CALL_ACTION_ACCEPTED)\n        this.start = new Date()\n        clearTimeout(this.hangUpTimer)\n        this.resetDuration(0)\n      })\n    },\n    isAccept() { // 对方接听自己发起的电话\n      clearTimeout(this.timer)\n      this.changeState('calling', true)\n      clearTimeout(this.hangUpTimer)\n      this.resetDuration(0)\n      this.start = new Date()\n    },\n    hangUp() { // 通话一段时间之后，某一方挂断电话\n      this.changeState('calling', false)\n      this.Trtc.leave()\n      this.end = new Date()\n      const duration = parseInt((this.end - this.start) / 1000)\n      this.sendVideoMessage(ACTION.VIDEO_CALL_ACTION_HANGUP, duration)\n      clearTimeout(this.hangUpTimer)\n    },\n    isHungUp() { // 通话一段时间之后，对方挂断电话\n      if (this.calling) {\n        this.changeState('calling', false)\n        this.Trtc.leave()\n        clearTimeout(this.hangUpTimer)\n      }\n    },\n    busy(videoPayload, messageItem) {\n      videoPayload.action = ACTION.VIDEO_CALL_ACTION_LINE_BUSY\n      const message = this.tim.createCustomMessage({\n        to: messageItem.from,\n        conversationType: this.currentConversationType,\n        payload: {\n          data: JSON.stringify(videoPayload),\n          description: '',\n          extension: ''\n        }\n      })\n      this.$store.commit('pushCurrentMessageList', message)\n      this.tim.sendMessage(message)\n    },\n    videoHandler() { // 是否打开摄像头\n      if (this.isCamOn) {\n        this.isCamOn = false\n        this.maskShow = true\n        this.Trtc.muteLocalVideo()\n      } else {\n        this.isCamOn = true\n        this.maskShow = false\n        this.Trtc.unmuteLocalVideo()\n      }\n    },\n    micHandler() { // 是否打开麦克风\n      if (this.isMicOn) {\n        this.isMicOn = false\n        this.Trtc.muteLocalAudio()\n      } else {\n        this.isMicOn = true\n        this.Trtc.unmuteLocalAudio()\n      }\n    },\n    sendVideoMessage(action, duration = 0) {\n      const options = {\n        room_id: this.videoRoom,\n        call_id: '',\n        action,\n        version: VERSION,\n        invited_list: [],\n        duration\n      }\n      const message = this.tim.createCustomMessage({\n        to: this.toAccount,\n        conversationType: this.currentConversationType,\n        payload: {\n          data: JSON.stringify(options),\n          description: '',\n          extension: ''\n        }\n      })\n      this.$store.commit('pushCurrentMessageList', message)\n      this.tim.sendMessage(message)\n    },\n    changeMainVideo() {\n      if (!this.calling) {\n        return\n      }\n      this.isLocalMain = !this.isLocalMain\n    }\n  }\n}\n",null]}